<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductVersion="1.0.0.0" ?>
  <?define ProductName="Photonize" ?>
  <?define Manufacturer="Photonize" ?>
  <?define UpgradeCode="{E8F9A0B1-2C3D-4E5F-6A7B-8C9D0E1F2A3B}" ?>

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="$(var.ProductName) Installer"
             Comments="Photo organization and batch renaming tool" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Note: .NET 8 Runtime required but not checked during installation -->
    <!-- Users should install from: https://dotnet.microsoft.com/download/dotnet/8.0 -->

    <!-- Installation directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Photonize" />
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Photonize"/>
      </Directory>

      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <!-- Components -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="PhotonizeExe" Guid="{1A2B3C4D-5E6F-7A8B-9C0D-1E2F3A4B5C6D}">
        <File Id="PhotonizeEXE"
              Source="$(var.Photonize.TargetDir)Photonize.exe"
              KeyPath="yes"
              Checksum="yes" />
        <File Id="PhotonizeDLL"
              Source="$(var.Photonize.TargetDir)Photonize.dll" />
        <File Id="PhotonizeRuntimeConfigJson"
              Source="$(var.Photonize.TargetDir)Photonize.runtimeconfig.json" />
        <File Id="PhotonizeDepsJsonFile"
              Source="$(var.Photonize.TargetDir)Photonize.deps.json" />
      </Component>

      <!-- NuGet Dependencies -->
      <Component Id="NewtonsoftJson" Guid="{5E6F7A8B-9C0D-1E2F-3A4B-5C6D7E8F9A0B}">
        <File Id="NewtonsoftJsonDll"
              Source="$(var.Photonize.TargetDir)Newtonsoft.Json.dll"
              KeyPath="yes" />
      </Component>

      <Component Id="CommunityToolkitMvvm" Guid="{6F7A8B9C-0D1E-2F3A-4B5C-6D7E8F9A0B1C}">
        <File Id="CommunityToolkitMvvmDll"
              Source="$(var.Photonize.TargetDir)CommunityToolkit.Mvvm.dll"
              KeyPath="yes" />
      </Component>

      <Component Id="GongWpfDragDrop" Guid="{7A8B9C0D-1E2F-3A4B-5C6D-7E8F9A0B1C2D}">
        <File Id="GongWpfDragDropDll"
              Source="$(var.Photonize.TargetDir)GongSolutions.WPF.DragDrop.dll"
              KeyPath="yes" />
      </Component>

      <Component Id="SixLaborsImageSharp" Guid="{C2D3E4F5-A6B7-8C9D-0E1F-2A3B4C5D6E7F}">
        <File Id="SixLaborsImageSharpDll"
              Source="$(var.Photonize.TargetDir)SixLabors.ImageSharp.dll"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Start Menu Shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="{8B9C0D1E-2F3A-4B5C-6D7E-8F9A0B1C2D3E}">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Photonize"
                  Description="Photo organization and batch renaming tool"
                  Target="[INSTALLFOLDER]Photonize.exe"
                  WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Photonize"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Desktop Shortcut (Optional) -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="{9C0D1E2F-3A4B-5C6D-7E8F-9A0B1C2D3E4F}">
        <Shortcut Id="DesktopShortcut"
                  Name="Photonize"
                  Description="Photo organization and batch renaming tool"
                  Target="[INSTALLFOLDER]Photonize.exe"
                  WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="CleanUpDesktopShortcut" Directory="DesktopFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Photonize"
                       Name="desktopShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Windows Explorer Context Menu Integration -->
    <DirectoryRef Id="TARGETDIR">
      <!-- Right-click on folder -->
      <Component Id="FolderContextMenu" Guid="{A0B1C2D3-E4F5-6A7B-8C9D-0E1F2A3B4C5D}">
        <RegistryKey Root="HKCR" Key="Directory\shell\Photonize">
          <RegistryValue Type="string" Value="Open in Photonize" />
          <RegistryValue Name="Icon" Type="string" Value="[INSTALLFOLDER]Photonize.exe,0" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key="Directory\shell\Photonize\command">
          <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]Photonize.exe&quot; -d &quot;%1&quot;" />
        </RegistryKey>
        <RegistryValue Root="HKCU"
                       Key="Software\Photonize"
                       Name="folderContextMenu"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>

      <!-- Right-click on folder background -->
      <Component Id="FolderBackgroundContextMenu" Guid="{B1C2D3E4-F5A6-7B8C-9D0E-1F2A3B4C5D6E}">
        <RegistryKey Root="HKCR" Key="Directory\Background\shell\Photonize">
          <RegistryValue Type="string" Value="Open in Photonize" />
          <RegistryValue Name="Icon" Type="string" Value="[INSTALLFOLDER]Photonize.exe,0" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key="Directory\Background\shell\Photonize\command">
          <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]Photonize.exe&quot; -d &quot;%V&quot;" />
        </RegistryKey>
        <RegistryValue Root="HKCU"
                       Key="Software\Photonize"
                       Name="folderBackgroundContextMenu"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>

      <!-- Right-click on image files (multi-select supported) -->
      <Component Id="ImageFileContextMenu" Guid="{D3E4F5A6-B7C8-9D0E-1F2A-3B4C5D6E7F8A}">
        <!-- Register for .jpg files -->
        <RegistryKey Root="HKCR" Key=".jpg\shell\PhotonizeExportWebP">
          <RegistryValue Type="string" Value="Export to WebP" />
          <RegistryValue Name="Icon" Type="string" Value="[INSTALLFOLDER]Photonize.exe,0" />
          <RegistryValue Name="MultiSelectModel" Type="string" Value="Player" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key=".jpg\shell\PhotonizeExportWebP\command">
          <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]Photonize.exe&quot; -e %*" />
        </RegistryKey>

        <!-- Register for .jpeg files -->
        <RegistryKey Root="HKCR" Key=".jpeg\shell\PhotonizeExportWebP">
          <RegistryValue Type="string" Value="Export to WebP" />
          <RegistryValue Name="Icon" Type="string" Value="[INSTALLFOLDER]Photonize.exe,0" />
          <RegistryValue Name="MultiSelectModel" Type="string" Value="Player" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key=".jpeg\shell\PhotonizeExportWebP\command">
          <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]Photonize.exe&quot; -e %*" />
        </RegistryKey>

        <!-- Register for .png files -->
        <RegistryKey Root="HKCR" Key=".png\shell\PhotonizeExportWebP">
          <RegistryValue Type="string" Value="Export to WebP" />
          <RegistryValue Name="Icon" Type="string" Value="[INSTALLFOLDER]Photonize.exe,0" />
          <RegistryValue Name="MultiSelectModel" Type="string" Value="Player" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key=".png\shell\PhotonizeExportWebP\command">
          <RegistryValue Type="string" Value="&quot;[INSTALLFOLDER]Photonize.exe&quot; -e %*" />
        </RegistryKey>

        <RegistryValue Root="HKCU"
                       Key="Software\Photonize"
                       Name="imageFileContextMenu"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Features -->
    <Feature Id="ProductFeature" Title="Photonize" Level="1">
      <ComponentRef Id="PhotonizeExe" />
      <ComponentRef Id="NewtonsoftJson" />
      <ComponentRef Id="CommunityToolkitMvvm" />
      <ComponentRef Id="GongWpfDragDrop" />
      <ComponentRef Id="SixLaborsImageSharp" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>

    <Feature Id="DesktopShortcutFeature" Title="Desktop Shortcut" Level="1">
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <Feature Id="ExplorerIntegrationFeature" Title="Windows Explorer Integration" Level="1"
             Description="Adds 'Open in Photonize' and 'Export to WebP' to the right-click context menu in Windows Explorer">
      <ComponentRef Id="FolderContextMenu" />
      <ComponentRef Id="FolderBackgroundContextMenu" />
      <ComponentRef Id="ImageFileContextMenu" />
    </Feature>

    <!-- UI -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- License -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Icons -->
    <Icon Id="icon.ico" SourceFile="Photonize.ico"/>
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <!-- Add/Remove Programs -->
    <Property Id="ARPHELPLINK" Value="https://github.com/yourusername/photonize" />
  </Product>
</Wix>
