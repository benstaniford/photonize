name: Build Windows App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.1.0 or 0.1.0)'
        required: false
        default: 'dev-build'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          # Remove 'v' prefix if present
          $NUMERIC_VERSION = $VERSION -replace '^v', ''
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "NUMERIC_VERSION=$NUMERIC_VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $NUMERIC_VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup WiX Toolset
        run: |
          Write-Host "Installing WiX Toolset..."
          choco install wixtoolset -y --no-progress
          Write-Host "Refreshing environment..."
          refreshenv
          # Add WiX to PATH for this session
          $env:PATH += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
          echo "PATH=$env:PATH" >> $env:GITHUB_ENV

      - name: Update WiX Product Version
        run: |
          $version = "${{ steps.version.outputs.NUMERIC_VERSION }}"
          $wxsPath = "Photonize.Installer/Product.wxs"

          Write-Host "Updating Product.wxs with version: $version"

          # Read the current content
          $content = Get-Content $wxsPath -Raw

          # Update the version define at the top of the file
          $content = $content -replace '(?<=<\?define ProductVersion=")[\d\.]*(?=" \?>)', $version

          # Write back to file
          Set-Content $wxsPath -Value $content -NoNewline

          Write-Host "âœ“ Product.wxs updated"
          Write-Host "Updated version line:"
          Get-Content $wxsPath | Select-String "define ProductVersion"

      - name: Restore dependencies
        run: dotnet restore Photonize/Photonize.csproj

      - name: Build Photonize Application
        run: dotnet build Photonize/Photonize.csproj -c Release --no-restore

      - name: Publish Photonize Application
        run: dotnet publish Photonize/Photonize.csproj -c Release -o Photonize/bin/Release/net8.0-windows/publish --no-build

      - name: Build WiX Installer
        run: |
          $env:PATH += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
          Write-Host "Building WiX installer..."
          msbuild Photonize.Installer/Photonize.Installer.wixproj /p:Configuration=Release /p:Platform=x64 /v:normal
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âœ— WiX build failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          Write-Host "âœ“ WiX build completed"

      - name: Verify and rename MSI file
        run: |
          $version = "${{ steps.version.outputs.NUMERIC_VERSION }}"

          Write-Host "Looking for MSI files..."
          Write-Host "Contents of Photonize.Installer directory:"
          Get-ChildItem Photonize.Installer -Recurse -ErrorAction SilentlyContinue | Where-Object {$_.Extension -eq ".msi"} | Format-Table FullName, Length

          # Handle MSI file
          $originalPath = "Photonize.Installer/bin/x64/Release/Photonize.msi"
          $newFileName = "PhotonizeInstaller-v$version-x64.msi"

          if (Test-Path $originalPath) {
            Write-Host "âœ“ MSI file found: $originalPath"
            $size = (Get-Item $originalPath).Length
            Write-Host "âœ“ MSI size: $([math]::Round($size / 1MB, 2)) MB"

            # Copy to root with new name
            Copy-Item -Path $originalPath -Destination $newFileName
            Write-Host "âœ“ MSI copied to root directory as: $newFileName"
          } else {
            Write-Host "âœ— MSI file not found: $originalPath"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: photonize-windows-${{ steps.version.outputs.NUMERIC_VERSION }}
          path: PhotonizeInstaller-v${{ steps.version.outputs.NUMERIC_VERSION }}-x64.msi
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "âœ… **Windows app built successfully**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.NUMERIC_VERSION }}" >> $env:GITHUB_STEP_SUMMARY
          echo "**Platform:** x64" >> $env:GITHUB_STEP_SUMMARY
          echo "**Artifact:** PhotonizeInstaller-v${{ steps.version.outputs.NUMERIC_VERSION }}-x64.msi" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ The MSI file has been uploaded as an artifact and will be available for 30 days." >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### Installation Instructions" >> $env:GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $env:GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP file to get the MSI" >> $env:GITHUB_STEP_SUMMARY
          echo "3. Run the MSI installer" >> $env:GITHUB_STEP_SUMMARY
          echo "4. Launch Photonize from the Start Menu or Desktop shortcut" >> $env:GITHUB_STEP_SUMMARY
